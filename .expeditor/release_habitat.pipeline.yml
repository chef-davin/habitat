expeditor:
  secrets:
    PIPELINE_HAB_AUTH_TOKEN:
      path: account/static/habitat/chef-ci
      field: auth_token # Production Builder
      # acceptance_auth_token = acceptance
  accounts:
    - aws/chef-cd
  defaults:
    buildkite:
      timeout_in_minutes: 45
      env:
        HAB_ORIGIN: "core"
        PIPELINE_HAB_BLDR_URL: "https://bldr.habitat.sh"
        # Necessary to prevent old studios from poisoning builds after core plans refreshes
        HAB_STUDIO_SECRET_HAB_FEAT_IGNORE_LOCAL: "true"

steps:
#######################################################################
# Release!
#######################################################################

  - label: "[:linux: build hab]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh hab
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build hab]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh hab
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - wait

  - label: "[:linux: build hab-plan-build]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh plan-build
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build hab-plan-build]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh plan-build
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - wait

  - label: "[:linux: build hab-backline]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh backline
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build hab-backline]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh backline
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - wait

  - label: "[:linux: build hab-studio]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh studio
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build hab-studio]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh studio
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - wait

  # Now that we've got a new Studio, we can build everything else
  # using the build toolchain we just built.

  - label: "[:linux: build launcher]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh launcher
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build launcher]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh launcher
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - label: "[:linux: build hab-sup]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh sup
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build hab-sup]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh sup
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - label: "[:linux: build hab-pkg-export-container]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh pkg-export-container
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: build hab-pkg-export-tar]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh pkg-export-tar
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - label: "[:linux: :two: build hab-pkg-export-tar]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh pkg-export-tar
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux-kernel2

  - label: "[:linux: build hab-pkg-mesosize]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh pkg-mesosize
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - wait

  # The cfize export currently has a dependency on
  # hab-pkg-export-container, so it must be built after that.
  - label: "[:linux: build hab-pkg-cfize]"
    command:
      - .expeditor/scripts/release_habitat/build_component.sh pkg-cfize
    expeditor:
      executor:
        docker:
          privileged: true
          environment:
            - BUILD_PKG_TARGET=x86_64-linux

  - wait

  - label: ":docker: Upload containers to Docker Hub"
    command: .expeditor/scripts/release_habitat/dockerhub_upload.sh
    if: build.creator.name == 'Chef Expeditor'
    env:
      BUILD_PKG_TARGET: "x86_64-linux"
    expeditor:
      executor:
        linux:
          privileged: true

  - label: ":docker: :two: Upload containers to Docker Hub"
    command: .expeditor/scripts/release_habitat/dockerhub_upload.sh
    if: build.creator.name == 'Chef Expeditor'
    env:
      BUILD_PKG_TARGET: "x86_64-linux-kernel2"
    expeditor:
      executor:
        linux:
          privileged: true
